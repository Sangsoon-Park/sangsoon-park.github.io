<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GPTì™€ ëŒ€í™”í•˜ê¸°</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; line-height: 1.45; }
    * { box-sizing: border-box; }
    body { margin: 0; background:#0b0c10; color:#eef1f5; }
    header { padding: 16px 24px; border-bottom: 1px solid #1f2330; position: sticky; top: 0; background:#0b0c10d9; backdrop-filter: blur(6px); z-index: 10;}
    main { max-width: 900px; margin: 0 auto; padding: 20px; }
    .row { display:flex; gap:10px; align-items: center; flex-wrap: wrap; }
    .grow { flex: 1 1 auto; }
    .pill { padding: 6px 10px; border-radius: 999px; background:#111420; border:1px solid #2a3042; color:#c8d0df; font-size: 12px; }
    .select, .input, .slider { background:#111420; color:#eef1f5; border:1px solid #2a3042; border-radius: 8px; padding: 10px; }
    .select { min-width: 170px; }
    .slider { padding: 8px; }
    .muted { color:#9aa3b2; font-size: 12px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; color:#a9b1c4; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-top:10px; }
    .panel { margin-top: 10px; padding: 12px; border-radius: 12px; background:#0e111a; border:1px solid #1f2330; }
    details > summary { cursor: pointer; user-select: none; }
    textarea { width: 100%; min-height: 90px; resize: vertical; background:#0b0e16; color:#eef1f5; border:1px solid #2a3042; border-radius: 8px; padding: 10px; }
    .chat { display:flex; flex-direction: column; gap: 12px; margin: 12px 0 16px; }
    .bubble { max-width: 82%; padding: 12px 14px; border-radius: 16px; white-space: pre-wrap; word-break: break-word; position: relative; }
    .user   { align-self: flex-end; background:#1a2033; border:1px solid #2a3042; }
    .assistant { align-self: flex-start; background:#111826; border:1px solid #1f2330; }
    .sysmsg { align-self: center; background:#0b0e16; border:1px dashed #2a3042; color:#a9b1c4; font-size: 12px; }
    .meta { font-size: 12px; color:#9aa3b2; }
    .err { color:#ffb4b4; }
    form.compose { display:flex; gap:10px; margin-top: 8px; }
    form.compose input[type="text"] { flex: 1; padding: 12px 14px; border-radius: 10px; border: 1px solid #2a3042; background:#111420; color:#eef1f5; }
    button { padding: 12px 16px; border-radius: 10px; border: 0; background:#5562ea; color:#fff; cursor:pointer; }
    button.secondary { background:#1f2330; color:#d7def0; border:1px solid #2a3042; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .spinner { width: 14px; height: 14px; border:2px solid #93a1ff; border-top-color: transparent; border-radius: 50%; display:inline-block; vertical-align: -2px; animation: spin 0.9s linear infinite; margin-right:6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .footer { margin-top: 10px; display:flex; gap:10px; justify-content: space-between; align-items: center; }
    a { color:#9cc0ff; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div><strong>GPTì™€ ëŒ€í™”í•˜ê¸°</strong></div>
    </div>

    <!-- ìƒë‹¨ ë„êµ¬ë§‰ëŒ€: ëª¨ë¸/ì˜¨ë„/íˆìŠ¤í† ë¦¬ ì œì–´ -->
    <div class="toolbar">
      <label class="muted">ëª¨ë¸
        <select id="model" class="select">
          <option value="gpt-4o-mini">gpt-4o-mini (ë¹ ë¥´ê³  ì €ë ´)</option>
          <option value="gpt-4o">gpt-4o (ì •í™•ë„â†‘)</option>
        </select>
      </label>

      <label class="muted">ì˜¨ë„
        <input id="temp" type="range" min="0" max="1" step="0.1" class="slider" style="width:160px" />
        <span id="tempVal" class="kbd">0.7</span>
      </label>

      <button id="clear" class="secondary" title="ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ì´ˆê¸°í™”">íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”</button>
      <button id="export" class="secondary" title="JSONìœ¼ë¡œ ì €ì¥">ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <input id="importFile" type="file" accept="application/json" hidden />
      <button id="import" class="secondary" title="JSONì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°">ë¶ˆëŸ¬ì˜¤ê¸°(JSON)</button>
    </div>

    <!-- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(í”„ë¡œí•„) ì„¤ì • -->
    <details id="sysPanel" class="panel">
      <summary><strong>ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(í”„ë¡œí•„)</strong> <span class="muted">â€” ë°±ì—”ë“œë¡œ í•¨ê»˜ ì „ì†¡ë©ë‹ˆë‹¤.</span></summary>
      <p class="muted" style="margin-top:6px">
        * ì—¬ê¸°ì˜ í…ìŠ¤íŠ¸ëŠ” <code>messages</code> ë°°ì—´ì˜ <code>system</code>ìœ¼ë¡œ í¬í•¨ë˜ì–´, ëª¨ë¸ì´ ë‹¹ì‹ ì˜ ë§¥ë½ì„ ì´í•´í•˜ë„ë¡ ë•ìŠµë‹ˆë‹¤.
        í•„ìš”ì‹œ ìˆ˜ì •í•˜ì„¸ìš”.
      </p>
      <textarea id="systemPrompt"></textarea>
    </details>
  </header>

  <main>
    <div id="chat" class="chat"></div>

    <!-- ì…ë ¥ì°½ -->
    <form id="composer" class="compose">
      <input id="q" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" autocomplete="off" />
      <button id="send" type="submit">ë³´ë‚´ê¸°</button>
      <button id="stop" type="button" class="secondary" disabled>ì¤‘ì§€</button>
    </form>


  </main>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // âš™ï¸ í™˜ê²½ì„¤ì •
    // ì ˆëŒ€ê²½ë¡œ ì‚¬ìš©: ë¡œì»¬ íŒŒì¼ë¡œ ì—´ì–´ë„ Vercel APIë¡œ ì§ì ‘ POSTí•©ë‹ˆë‹¤.
    const ENDPOINT = 'https://my-chat-five-kappa.vercel.app/api/chat';

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
    const LS_HISTORY = 'chat.history.v1';
    const LS_MODEL   = 'chat.model.v1';
    const LS_TEMP    = 'chat.temp.v1';
    const LS_SYSTEM  = 'chat.system.v1';

    // DOM ì°¸ì¡°
    const chatEl  = document.getElementById('chat');
    const form    = document.getElementById('composer');
    const input   = document.getElementById('q');
    const btnSend = document.getElementById('send');
    const btnStop = document.getElementById('stop');
    const btnClear= document.getElementById('clear');
    const btnExport= document.getElementById('export');
    const btnImport= document.getElementById('import');
    const fileImport= document.getElementById('importFile');

    const modelSel= document.getElementById('model');
    const tempRange= document.getElementById('temp');
    const tempVal = document.getElementById('tempVal');
    const sysTA   = document.getElementById('systemPrompt');

    // ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (í•„ìš”ì‹œ ììœ ë¡­ê²Œ ìˆ˜ì •)
    const DEFAULT_SYSTEM = [
      'ë¬¸ì²´ëŠ” ì¹œê·¼í•˜ì§€ë§Œ ì—…ë¬´ ë§¥ë½ì—ì„œëŠ” ê°„ê²°í•˜ê³  êµ¬ì¡°í™”í•´ ì£¼ì„¸ìš”.',
      'ì‚¬ì†Œí•œ ì§ˆë¬¸ì—ëŠ” ì§§ê²Œ, ë³µì¡í•œ ì£¼ì œëŠ” ë‹¨ê³„ì ìœ¼ë¡œ ì„¤ëª…í•´ ì£¼ì„¸ìš”.',
      'í•„ìš” ì‹œ ì‚¬ìš©ì ë§¥ë½(ì¡°ì§/ì—­í• /ê¸°ìˆ ìŠ¤íƒ)ì„ ì „ì œë¡œ ì˜ˆì‹œë¥¼ ë“¤ì–´ì£¼ì„¸ìš”.'
    ].join('\n');

    // ìƒíƒœ
    let history = []; // [{role:'user'|'assistant'|'system', content:string}, ...]
    let controller = null; // AbortController for streaming

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ§  ìœ í‹¸
    function saveLS(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
    function loadLS(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch { return fallback; }
    }

    function addBubble(text, who) {
      const div = document.createElement('div');
      div.className = 'bubble ' + who;
      div.textContent = text;
      chatEl.appendChild(div);
      div.scrollIntoView({ behavior: 'smooth', block: 'end' });
      return div;
    }
    function appendText(div, text) {
      div.textContent += text;
      div.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
    function renderFullHistory() {
      chatEl.innerHTML = '';
      const sys = loadLS(LS_SYSTEM, DEFAULT_SYSTEM);
      if (sys) addBubble('ì‹œìŠ¤í…œ: ' + sys, 'sysmsg');
      for (const m of history) addBubble(m.content, m.role === 'user' ? 'user' : 'assistant');
    }

    // SSE ë¸”ë¡ íŒŒì„œ (Responses API & Chat Completions ë‘˜ ë‹¤ ì²˜ë¦¬)
    function handleSSEChunk(part, aDiv) {
      const lines = part.split('\n').map(l => l.trim());
      const dataLines = lines.filter(l => l.startsWith('data:'));
      for (const dl of dataLines) {
        const data = dl.slice(5).trim();
        if (!data) continue;
        if (data === '[DONE]') return { done: true }; // chat/completions ì¢…ë£Œ ì‹ í˜¸
        try {
          const json = JSON.parse(data);

          // Responses API (type ê¸°ë°˜)
          if (json.type) {
            if (json.type === 'response.output_text.delta' && typeof json.delta === 'string') {
              appendText(aDiv, json.delta);
            } else if (json.type === 'response.completed' || json.type === 'response.output_text.done') {
              return { done: true };
            }
            continue;
          }

          // Chat Completions (choices[0].delta.content)
          const delta = json?.choices?.[0]?.delta;
          if (delta?.content) appendText(aDiv, delta.content);
        } catch (_) { /* JSONì´ ì•„ë‹ˆë©´ ë¬´ì‹œ */ }
      }
      return { done: false };
    }

    function setBusy(busy) {
      btnSend.disabled = busy;
      input.disabled = busy;
      btnStop.disabled = !busy;
      if (busy) {
        btnSend.dataset.prev = btnSend.textContent;
        btnSend.innerHTML = '<span class="spinner"></span>ìƒê°ì¤‘â€¦';
      } else {
        btnSend.textContent = btnSend.dataset.prev || 'ë³´ë‚´ê¸°';
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â¯ï¸ ìŠ¤íŠ¸ë¦¬ë° í˜¸ì¶œ
    async function streamChat(userText) {
      // UI ë°˜ì˜
      addBubble(userText, 'user');
      history.push({ role: 'user', content: userText });
      saveLS(LS_HISTORY, history);
      const aDiv = addBubble('', 'assistant');

      setBusy(true);
      controller = new AbortController();

      const model = modelSel.value;
      const temperature = Number(tempRange.value);
      const system = sysTA.value.trim();

      // ë°±ì—”ë“œì™€ í˜¸í™˜ë˜ëŠ” ë©”ì‹œì§€ ë°°ì—´ êµ¬ì„±
      const messages = [];
      if (system) messages.push({ role: 'system', content: system });
      for (const m of history) messages.push(m);

      const body = { model, stream: true, temperature, messages };

      let resp;
      try {
        resp = await fetch(ENDPOINT, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
          signal: controller.signal
        });
      } catch (e) {
        aDiv.classList.add('err');
        appendText(aDiv, `ìš”ì²­ ì‹¤íŒ¨: ${e.message}`);
        setBusy(false);
        return;
      }

      if (!resp.ok) {
        const text = await resp.text().catch(()=> '');
        aDiv.classList.add('err');
        appendText(aDiv, `ì„œë²„ ì˜¤ë¥˜ ${resp.status}: ${text || 'ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ'}\n(â€» ë¸Œë¼ìš°ì €ê°€ GETìœ¼ë¡œ ë³´ë‚´ë©´ 405ê°€ ë‚©ë‹ˆë‹¤. ì´ í™”ë©´ì€ POSTë¡œ ì „ì†¡í•©ë‹ˆë‹¤.)`);
        setBusy(false);
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '', stop = false;

      try {
        while (!stop) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });

          // SSEëŠ” ë¹ˆ ì¤„(\n\n)ë¡œ ì´ë²¤íŠ¸ êµ¬ë¶„
          const parts = buffer.split('\n\n');
          buffer = parts.pop() || '';
          for (const part of parts) {
            const { done: partDone } = handleSSEChunk(part, aDiv);
            if (partDone) { stop = true; break; }
          }
        }
      } catch (err) {
        if (err.name === 'AbortError') {
          aDiv.classList.add('err');
          appendText(aDiv, '\n(ì „ì†¡ ì¤‘ë‹¨ë¨)');
        } else {
          aDiv.classList.add('err');
          appendText(aDiv, `\n(ìŠ¤íŠ¸ë¦¬ë° ì¤‘ë‹¨: ${err.message})`);
        }
      } finally {
        // ìŠ¤íŠ¸ë¦¼ì´ ëë‚œ ì‹œì ì˜ ì–´ì‹œìŠ¤í„´íŠ¸ í…ìŠ¤íŠ¸ë¥¼ íˆìŠ¤í† ë¦¬ì— ì €ì¥
        const content = aDiv.textContent;
        history.push({ role: 'assistant', content });
        saveLS(LS_HISTORY, history);
        setBusy(false);
        controller = null;
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ§­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      input.value = '';
      streamChat(text);
    });

    btnStop.addEventListener('click', () => {
      if (controller) controller.abort();
    });

    tempRange.addEventListener('input', () => {
      tempVal.textContent = tempRange.value;
      saveLS(LS_TEMP, tempRange.value);
    });

    modelSel.addEventListener('change', () => {
      saveLS(LS_MODEL, modelSel.value);
    });

    btnClear.addEventListener('click', () => {
      if (!confirm('ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
      history = [];
      saveLS(LS_HISTORY, history);
      renderFullHistory();
    });

    btnExport.addEventListener('click', () => {
      const data = {
        model: modelSel.value,
        temperature: Number(tempRange.value),
        system: sysTA.value,
        history
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'chat-export-' + new Date().toISOString().replace(/[:.]/g, '-') + '.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    btnImport.addEventListener('click', () => fileImport.click());
    fileImport.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      try {
        const txt = await f.text();
        const data = JSON.parse(txt);
        if (data.model) modelSel.value = data.model;
        if (typeof data.temperature === 'number') tempRange.value = String(data.temperature);
        if (typeof data.system === 'string') sysTA.value = data.system;
        if (Array.isArray(data.history)) history = data.history;
        saveLS(LS_MODEL, modelSel.value);
        saveLS(LS_TEMP, tempRange.value);
        saveLS(LS_SYSTEM, sysTA.value);
        saveLS(LS_HISTORY, history);
        tempVal.textContent = tempRange.value;
        renderFullHistory();
      } catch (err) {
        alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ' + err.message);
      } finally {
        fileImport.value = '';
      }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸš€ ì´ˆê¸°í™”
	localStorage.removeItem(LS_SYSTEM);   // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë§Œ ì´ˆê¸°í™”, historyëŠ” ìœ ì§€ 
	
    (function init(){
      // ì €ì¥ëœ ê°’ ë³µì›
      const savedModel = loadLS(LS_MODEL, 'gpt-4o-mini');
      const savedTemp  = loadLS(LS_TEMP, 0.7);
      const savedSys   = loadLS(LS_SYSTEM, DEFAULT_SYSTEM);
      history = loadLS(LS_HISTORY, []);

      modelSel.value = savedModel;
      tempRange.value = savedTemp;
      tempVal.textContent = savedTemp;
      sysTA.value = savedSys;

      // ê¸°ì¡´ ëŒ€í™” ë Œë”
      renderFullHistory();

      // ì²« ë°©ë¬¸ ì•ˆë‚´
      if (!history.length) {
        addBubble('ì•ˆë…•í•˜ì„¸ìš”! ëª¨ë¸/ì˜¨ë„/ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì„¤ì •í•˜ê³  ë©”ì‹œì§€ë¥¼ ë³´ë‚´ ë³´ì„¸ìš”.','assistant');
      }
    })();
  </script>
</body>
</html>
